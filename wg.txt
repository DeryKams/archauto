sudo apt update && sudo apt upgrade -y
sudo apt install wireguard resolvconf linux-headers-$(uname -r) iptables-persistent -y

nano /etc/sysctl.conf

#Для работы wireguard
net.ipv4.ip_forward = 1
net.ipv6.conf.all.forwarding=1
# Оптимизация сетевого стека
net.core.rmem_max = 800000
net.core.wmem_max = 800000
net.core.netdev_max_backlog = 50000
net.ipv4.tcp_congestion_control = bbr
net.ipv4.tcp_notsent_lowat = 4096
net.ipv4.tcp_mtu_probing = 1
net.ipv4.tcp_fastopen = 3
net.ipv4.udp_rmem_min = 16384
net.ipv4.udp_wmem_min = 16384
net.core.default_qdisc = fq_codel
net.ipv4.tcp_ecn = 1
net.ipv4.tcp_sack = 0
net.ipv4.tcp_dsack = 0

sudo sysctl -p

wg genkey | tee /etc/wireguard/privatekey && cat /etc/wireguard/privatekey | wg pubkey > /etc/wireguard/publickey && cat /etc/wireguard/publickey

mHmFnownIY9hfiJV5FT02p4/SHoA3D05VYBdAXdCQHk=
TO81l6ve4gaXmIRExk6wfqtfZVoisrYo6ovBEe/VAAY=


wg genkey | tee /etc/wireguard/peer_1_privatekey  && cat /etc/wireguard/peer_1_privatekey | wg pubkey | tee /etc/wireguard/peer_1_publickey

+E5Kfhm/laeoUzY/BlvIe4wa07Z3buUlHgkLAmYRkFk=
E94SqdNfagEiEKGqfqvwbN+lUs02PDNeSWVWY9ienEA=

wg genkey | tee /etc/wireguard/peer_2_privatekey  && cat /etc/wireguard/peer_2_privatekey | wg pubkey | tee /etc/wireguard/peer_2_publickey

uD4U2pR4hbd7kzUG6MjkH9jHcBV4qg7Vq0VA2B779Hg=
pYTSBR0hOo+esxIFT3ZaA6AwobQfJB0u/VabceHVtwI=

ip a
#нужно получить имя реального интерфейса ens3 или eth0 и на подобие

nano /etc/wireguard/wg0.conf

[Interface]
PrivateKey = <server_private_key>
Address = 10.13.13.1/24
ListenPort = 443
DNS = 8.8.8.8
MTU = 1460  

# Автоматизация проброса трафика
PostUp = iptables -A FORWARD -i wg0 -o ens3 -j ACCEPT; iptables -A FORWARD -i ens3 -o wg0 -m state --state RELATED,ESTABLISHED -j ACCEPT; iptables -t nat -A POSTROUTING -o ens3 -j MASQUERADE 
PostDown = iptables -D FORWARD -i wg0 -o ens3 -j ACCEPT; iptables -D FORWARD -i ens3 -o wg0 -m state --state RELATED,ESTABLISHED -j ACCEPT; iptables -t nat -D POSTROUTING -o ens3 -j MASQUERADE

[Peer]
#peer_1
PublicKey = <client_public_key(peer_1_publickey)>
AllowedIPs = 10.13.13.2/32
PersistentKeepalive = 25  # Критично для обхода NAT

nano /etc/wireguard/peer_1.conf

[Interface]
Address = 10.13.13.2/32
PrivateKey = <client1_private_key(/etc/wireguard/peer_1_privatekey)>
DNS = 8.8.8.8
MTU = 1460  

[Peer]
PublicKey = <server_public_key(/etc/wireguard/publickey)>
Endpoint = <server-ip>:443
AllowedIPs = 0.0.0.0/0, ::/0
PersistentKeepalive = 25

sudo iptables -t nat -F
sudo iptables -F
sudo netfilter-persistent save

sudo wg-quick down wg0
wg-quick up wg0
systemctl enable wg-quick@wg0


sudo apt install shadowsocks-libev -y

nano /etc/shadowsocks-libev/config.json

{
  "server": "0.0.0.0",
  "server_port": 443,
  "password": "YourStrongPassword!",
  "method": "chacha20-ietf-poly1305",
  "mode": "tcp_and_udp",
  "timeout": 7200,
  "fast_open": true
}

nano /etc/wireguard/wg0.conf

[Interface]
PrivateKey = <server_private_key>
Address = 10.13.13.1/24
ListenPort = 51820  # Локальный порт
DNS = 8.8.8.8
MTU = 1420  # Исправлено!

PostUp = iptables -A FORWARD -i wg0 -j ACCEPT; ip6tables -A FORWARD -i wg0 -j ACCEPT
PostDown = iptables -D FORWARD -i wg0 -j ACCEPT; ip6tables -D FORWARD -i wg0 -j ACCEPT

sudo systemctl enable shadowsocks-libev
sudo systemctl start shadowsocks-libev
sudo wg-quick down wg0
sudo wg-quick up wg0

nano /etc/wireguard/peer_1.conf

[Interface]
PrivateKey = <client_private_key>
Address = 10.13.13.2/32
DNS = 8.8.8.8
MTU = 1420

# Настроить прокси через Shadowsocks
PreUp = start-shadowsocks-script.sh  # Автозапуск Shadowsocks

[Peer]
PublicKey = <server_public_key>
Endpoint = 127.0.0.1:51820  # Подключаемся к локальному Shadowsocks
AllowedIPs = 0.0.0.0/0, ::/0
PersistentKeepalive = 25

nano start-shadowsocks-script.sh
#!/bin/bash
# Для Windows используйте .bat скрипт
ss-local -c /path/to/shadowsocks.json &

# Вместо очистки всех правил:
sudo iptables -D FORWARD -i wg0 -o eth0 -j ACCEPT 2>/dev/null